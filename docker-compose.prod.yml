version: "3.9"
services:
  ### START section - kafka and related ##
  zookeeper:
    image: bitnami/zookeeper@sha256:7d556bd2d702074d2552b84474fff078af74b25c633ac580d73344d1847c0f35
    restart: always
    networks:
      - pigeon
    volumes:
      - "zookeeper_data:/bitnami"
    environment:
      - ALLOW_ANONYMOUS_LOGIN=yes
    healthcheck:
      test: ["CMD", "bash", "-c", "unset", "JMX_PORT", ";", "kafka-topics.sh", "--zookeeper", "zookeeper:2181", "--list"]
      interval: 15s
      timeout: 5s
      retries: 5
  kafka:
    image: bitnami/kafka@sha256:bd10e6927f5bf8ee8a5b66d522dd5e2945aede4fdedaf10b2e0f973689874dbd
    restart: always
    networks:
      - pigeon
    volumes:
      - "kafka_data:/bitnami"
    environment:
      - KAFKA_ENABLE_KRAFT=no
      - KAFKA_CFG_ZOOKEEPER_CONNECT=zookeeper:2181
      - KAFKA_CFG_LISTENERS=INTERNAL://:9092,EXTERNAL://:29092
      - KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP=INTERNAL:PLAINTEXT,EXTERNAL:PLAINTEXT
      - KAFKA_CFG_ADVERTISED_LISTENERS=INTERNAL://kafka:9092,EXTERNAL://localhost:29092
      - KAFKA_CFG_INTER_BROKER_LISTENER_NAME=INTERNAL
      - ALLOW_PLAINTEXT_LISTENER=yes
    depends_on:
      - zookeeper
    healthcheck:
      test: ["CMD", "/bitnami/kafka/healthcheck.sh"]
      interval: 15s
      timeout: 5s
      retries: 5
      start_period: 65s
  init-kafka:
    image: ghcr.io/kneu-messenger-pigeon/init-kafka@sha256:64c5569b8bb087ec6c8347e31a595a48de89b9b28f3104f3be930c69ab14c705
    networks:
      - pigeon
    volumes:
      - "kafka_data:/bitnami"
    environment:
      - KAFKA_HOST=kafka:9092
      - CREATE_HEALTHCHECK_SCRIPT=/bitnami/kafka/healthcheck.sh
      # must be greater then services.kafka.healthcheck.interval (don't exit container until healthcheck done for Kafka service)
      - FINISH_TIMEOUT=16
    restart: on-failure
    depends_on:
      kafka:
        condition: service_started
  kafka-ui:
    image: provectuslabs/kafka-ui@sha256:477d4c3d896a0deefdcccf0e08e8fb0d4258e5340d34f3c3513f75073de5835c
    ports:
      - "8892:8080"
    networks:
      - pigeon
    restart: unless-stopped
    environment:
      - KAFKA_CLUSTERS_0_NAME=local
      - KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS=kafka:9092
    depends_on:
      kafka:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "nc", "-vz", "localhost", "8080"]
      interval: 15s
      timeout: 5s
      retries: 3
  ### END section - kafka and related ##

  secondary-db-watcher:
    image: ghcr.io/kneu-messenger-pigeon/secondary-db-watcher@sha256:d1d2264eebe0d3acaf8523349913087fb27e7e37495a4287828cad29e52a4273
    restart: always
    volumes:
      - "secondary-db-watcher-storage:/storage"
    networks:
      - pigeon
    environment:
      - INFISICAL_TOKEN=$INFISICAL_TOKEN
      - KAFKA_HOST=kafka:9092
      #      - SECONDARY_DEKANAT_DB_DSN=${SECONDARY_DEKANAT_DB_DSN}
      - PAUSE_AFTER_SUCCESS=600
      - PAUSE_AFTER_ERROR=60
      - ERROR_COUNT_TO_BREAK=3
    depends_on:
      kafka:
        condition: service_healthy
    extra_hosts:
      - "host.docker.internal:host-gateway"
  ### START section - secondary db importer ###
  secondary-db-disciplines-importer:
    image: ghcr.io/kneu-messenger-pigeon/secondary-db-disciplines-importer@sha256:b829c7607430dc5f323e7f9a76026a4fdf17525a3091a5f2bd9e65b027ef4ce4
    restart: always
    networks:
      - pigeon
    environment:
      - INFISICAL_TOKEN=$INFISICAL_TOKEN
      - KAFKA_HOST=kafka:9092
      #      - SECONDARY_DEKANAT_DB_DSN=${SECONDARY_DEKANAT_DB_DSN}
    depends_on:
      kafka:
        condition: service_healthy
    extra_hosts:
      - "host.docker.internal:host-gateway"
  secondary-db-lessons-importer:
    image: ghcr.io/kneu-messenger-pigeon/secondary-db-lessons-importer@sha256:a2f36f7207be5ad1369cf3d3b8cded086181a5066838c74b268dfd5bc0726a1e
    restart: always
    networks:
      - pigeon
    environment:
      - INFISICAL_TOKEN=$INFISICAL_TOKEN
      - KAFKA_HOST=kafka:9092
      #      - SECONDARY_DEKANAT_DB_DSN=${SECONDARY_DEKANAT_DB_DSN}
    depends_on:
      kafka:
        condition: service_healthy
    extra_hosts:
      - "host.docker.internal:host-gateway"
  secondary-db-scores-importer:
    image: ghcr.io/kneu-messenger-pigeon/secondary-db-scores-importer@sha256:fbe55d3f54eae0898c2a3494a3650aa64bfbaf66c5c8ad774150ff8a07728f78
    restart: always
    networks:
      - pigeon
    environment:
      - INFISICAL_TOKEN=$INFISICAL_TOKEN
      - KAFKA_HOST=kafka:9092
      #      - SECONDARY_DEKANAT_DB_DSN=${SECONDARY_DEKANAT_DB_DSN}
    depends_on:
      kafka:
        condition: service_healthy
    extra_hosts:
      - "host.docker.internal:host-gateway"
  ### END section - secondary db importer ###

  ## Fake line to catch by `build-combined-readme.sh` and put into README.md Microservices
  ## image: ghcr.io/kneu-messenger-pigeon/realtime-changes-event-sender:main
  realtime-importer:
    image: ghcr.io/kneu-messenger-pigeon/realtime-importer@sha256:942083aef49b280bf5121a2a68a837aac237dbd7cf88d7a1289712ab4fe9a870
    restart: always
    networks:
      - pigeon
    volumes:
      - "realtime-importer-storage:/storage"
    environment:
      - INFISICAL_TOKEN=$INFISICAL_TOKEN
      - KAFKA_HOST=kafka:9092
      #      - PRIMARY_DEKANAT_DB_DSN=${PRIMARY_DEKANAT_DB_DSN}
      #      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      #      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      #      - AWS_SQS_QUEUE_URL=${AWS_SQS_QUEUE_URL}
      #      - AWS_REGION=${AWS_REGION}
    depends_on:
      kafka:
        condition: service_healthy
  ### START section - score storage ###
  score-storage-redis:
    image: redis@sha256:121bac949fb5f623b9fa0b4e4c9fb358ffd045966e754cfa3eb9963f3af2fe3b
    restart: always
    volumes:
      - score-storage-redis:/data
    networks:
      - pigeon
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 15s
      timeout: 5s
      retries: 3
  storage-writer:
    image: ghcr.io/kneu-messenger-pigeon/storage-writer@sha256:47fc2df66fa0ff0192860a89dfa14c94a5bc02e9b6e2e5c847c1ce246e38ccee
    restart: always
    networks:
      - pigeon
    environment:
      - INFISICAL_TOKEN=$INFISICAL_TOKEN
      - KAFKA_HOST=kafka:9092
      - REDIS_DSN=redis://score-storage-redis:6379
    depends_on:
      kafka:
        condition: service_healthy
      score-storage-redis:
        condition: service_healthy
  score-storage-api:
    image: ghcr.io/kneu-messenger-pigeon/score-storage-api@sha256:19fc8888840513bd4aeb9c2375a79973999d5d41df79f131cb006a5affbaf46d
    restart: always
    networks:
      - pigeon
    environment:
      - INFISICAL_TOKEN=$INFISICAL_TOKEN
      - REDIS_DSN=redis://score-storage-redis:6379
      - LISTEN=:80
    depends_on:
      score-storage-redis:
        condition: service_healthy
  ### END section - score storage ###

  authorizer:
    image: ghcr.io/kneu-messenger-pigeon/authorizer@sha256:060c793155ed773c1b5750037d6173f2af535726425ab6c229afe8361048f109
    restart: always
    ports:
      - "8890:80"
    networks:
      - pigeon
    environment:
      - INFISICAL_TOKEN=$INFISICAL_TOKEN
      - KAFKA_HOST=kafka:9092
      - LISTEN=:80
      #      - PUBLIC_URL=${AUTHORIZER_PUBLIC_URL}
      #      - KNEU_CLIENT_ID=${KNEU_CLIENT_ID}
      #      - KNEU_CLIENT_SECRET=${KNEU_CLIENT_SECRET}
      #      - APP_SECRET=${APP_SECRET}
      #      - JWT_SECRET_KEY=${JWT_SECRET_KEY}
    depends_on:
      kafka:
        condition: service_healthy
  ### START section - telegram app ###
  telegram-app-redis:
    image: redis@sha256:121bac949fb5f623b9fa0b4e4c9fb358ffd045966e754cfa3eb9963f3af2fe3b
    restart: always
    volumes:
      - telegram-app-redis:/data
    networks:
      - pigeon
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 15s
      timeout: 5s
      retries: 3
  telegram-app:
    image: ghcr.io/kneu-messenger-pigeon/telegram-app@sha256:ea4c3c9a32c5bb8348781b2588109ddb215366f118c40727e2b3951a2bb8689d
    restart: always
    networks:
      - pigeon
    environment:
      - INFISICAL_TOKEN=$INFISICAL_TOKEN
      - KAFKA_HOST=kafka:9092
      - REDIS_DSN=redis://telegram-app-redis:6379
      - SCORE_STORAGE_API_HOST=http://score-storage-api
      - AUTHORIZER_HOST=http://authorizer
      - COMMIT_THRESHOLD=1000
      #      - APP_SECRET=${APP_SECRET}
      #      - TELEGRAM_TOKEN=${TELEGRAM_TOKEN}
      #      - TIMEFRAME_TO_COMBINE_REPEAT_SCORE_CHANGES=${TIMEFRAME_TO_COMBINE_REPEAT_SCORE_CHANGES}
    depends_on:
      kafka:
        condition: service_healthy
      telegram-app-redis:
        condition: service_healthy
        ### END section - telegram app ###
volumes:
  secondary-db-watcher-storage:
    driver: local
  realtime-importer-storage:
    driver: local
  score-storage-redis:
    driver: local
  telegram-app-redis:
    driver: local
  zookeeper_data:
    driver: local
  kafka_data:
    driver: local
networks:
  pigeon:
    driver: bridge
